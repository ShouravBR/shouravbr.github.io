<!doctype html>
<html class="no-js" lang="en">

<head>
    <title>ShouravBR - Introduction to Python's multiprocessing Pool</title>




    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <!-- Place favicon.ico in the root directory -->
    <!-- <link rel="stylesheet" href="/static/css/github-pandoc.css"> -->
    <link rel="stylesheet" href="/static/css/normalize.css">
    
    <link rel="stylesheet" href="/static/css/main.css">
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-40269231-7"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'UA-40269231-7');
    </script>

    <meta charset="utf-8" />
    <meta name="generator" content="Pelican" />

    
</head>

<body>

    <nav class="monospace">
        <ul>
                <li><a href="/">Home</a></li>
                <li><a href="/notebook.html">Notebook</a></li>


        </ul>
    </nav>


<section id="content" class="body">
  <article>
    <header>
      <h2 class="entry-title">
        Introduction to Python's multiprocessing Pool
      </h2>
    </header>
    <footer class="post-info">
      <div>
          Last updated 
          <time class="modified" datetime="2022-03-03T14:24:46.291252+06:00">
            Thu 03 March 2022
          </time>
      </div>
      
      <!--       <address class="vcard author">
        By         <a class="url fn" href="/author/shourav-bin-rabbani.html">Shourav Bin Rabbani</a>
      </address>
 -->
      <div class="category">
        Category: <a href="/category/programming.html">Programming</a>
      </div>
    </footer><!-- /.post-info -->
    <div class="entry-content">
      <p>The multiprocessing <code>Pool</code> class makes it easy to achieve parallel execution. The official Python Docs <a href="https://docs.python.org/3/library/multiprocessing.html">[1]</a> is an excellent source that everyone should check for more details. In this post, we implement a few basic uses of multiprocessing pool as a module and use it from our "main" function.</p>
<h3>Use 1: Distributing the same work across a pool</h3>
<p>Suppose, we have to run a function, for example, get the squares ($f(x) = x^2)$, for every elements in an array of length <code>N</code>. However, <code>N</code> is large and executing it sequentially will take <code>T</code> time, which is large. Thankfully, you use a modern computer with multi-core processor. So you can evaluate the function for element in parallel.</p>
<p>For that, we first write a class called "Workers", which uses the multiprocessings library and store the function we need to run in parallel as the <code>@staticmethod</code> [<a href="https://docs.python.org/3/library/functions.html?highlight=staticmethod#staticmethod">2</a>]. Second, we use <code>Pool.imap_unordered</code> since the order of output does not matter and we can process the output as soon as it is available. There are, however, many different methods in the <code>Pool</code> class for different type of management. These can be found in the Python Docs <a href="https://docs.python.org/3/library/multiprocessing.html">[1]</a>. Finally, we save the class as "Worker.py".</p>
<p>Here's the code:</p>
<div class="highlight"><pre><span></span><code><span class="c1">## saved as Worker.py</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span>

<span class="k">class</span> <span class="nc">Workers</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">list_of_tasks</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list_of_tasks</span> <span class="o">=</span> <span class="n">list_of_tasks</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">square</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; returns square of number &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">*</span><span class="n">x</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">no_of_parallel_workers</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="n">no_of_parallel_workers</span><span class="p">)</span> <span class="k">as</span> <span class="n">p</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">imap_unordered</span><span class="p">(</span><span class="n">Workers</span><span class="o">.</span><span class="n">square</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_of_tasks</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">individual_result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">individual_result</span><span class="p">)</span>
</code></pre></div>

<p>Now, we import our module, create an instance of <code>Workers</code> and call the public function <code>run</code> within a condition. That is, we should not hastily run this function without checking the name of the scope. The scope is stored in the <code>__name__</code> global variable [<a href="https://docs.python.org/3/library/__main__.html">3</a>]. We must check if <code>__name__</code> is equal to <code>'__main__'</code> and then call <code>workers.run()</code>. This is because, on Windows, the multiprocessing library will clone the main process and create as many child processes as specified. Each of these child processes will go through the same lines of code, eventually reaching the <code>workers.run</code> line and clone themselves unless a conditional statment prevents them. During scope checking, the child process's <code>__name__</code> will not be in <code>'__main__'</code> scope and hence our code will only create new processes only once. In addition, checking the main scope is a good way to deny any unwanted code execution during module imports [<a href="https://stackoverflow.com/questions/419163/what-does-if-name-main-do">4</a>].</p>
<p>Here is the final code and output:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">workers</span> <span class="kn">import</span> <span class="n">Workers</span>

<span class="n">numbers_to_square</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>
<span class="n">workers</span> <span class="o">=</span> <span class="n">Workers</span><span class="p">(</span><span class="n">numbers_to_square</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c1"># use two parallel worker to get the square of numbers</span>
    <span class="n">workers</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> 
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="mf">1</span>
<span class="mf">4</span>
<span class="mf">9</span>
<span class="mf">16</span>
</code></pre></div>
    </div><!-- /.entry-content -->
  </article>
</section>

    <footer id="contentinfo" class="body">

<link rel="stylesheet"
href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.0.1/styles/default.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.0.1/highlight.min.js"></script>
<script>
    hljs.configure({
        languages: ['python','json','javascript']
    });
    hljs.highlightAll();
</script>
            <address id="about" class="vcard body">
            Site generated with <a href="https://getpelican.com/">Pelican</a>.
            </address><!-- /#about -->
    </footer><!-- /#contentinfo -->
</body>

</html>